---
title: javascript作用域
date: 2017-03-06 10:47:44
tags:
  - 学习总结
  - javascript
categories:
---
**笔记类文章**

## 作用域
每个环境能访问到的标识符集合，我们称之为“作用域”
有三种作用域：
- 全局
- 函数
- 块——{}

<!-- more -->
### 静态作用域
作用域在创建的时候会保存包含其的所有作用域中的变量对象集合，此构成了——静态作用域（在创建时获得的，静态定义的）
## 执行上下文
在进入某作用域之前：
  会创建对应的执行环境，以栈结构保存，后进先出，此为调用栈。
  执行环境（执行上下文）有各种记录器：
  - 代码执行状态
  - 函数——记录当前函数体
  - 范涛——内部对象集合，全局环境及其作用域下的所有代码，其他相关状态，资源
  - 词法环境
  - 变量环境

可以随时进入另一个作用域，并将当前执行环境挂起。

## 词法环境——变量环境
词法环境中：
- 环境记录：记录词法环境中所有标示符和具体值之间的联系
- 指向外部词法环境的引用

词法环境用来解析标示符，管理数据，并且引用外部词法环境，达到从内到外，连成一串。

## 作用域链

词法环境层层嵌套，且内部引用外部，将作用域链接了起来，这就是作用域链
在进入执行上下文之前，会构建此执行上下文的词法环境，并链接在创建时已经保存好的静态作用域前端，在解析标示符时，将第一个被访问。
这便构成了完整的，运行时的作用域链。

## 具体实现

任何对象均有[[scope]]属性

仅说函数（函数也是对象）

在函数创建时，[[scope]]保存下静态作用域——即此时执行环境的作用域链（因为还没有进入这个函数的执行环境，所以此时执行环境，还是包裹函数的那个执行环境）。

作用域链是一个索引，保存着每个执行环境的作用域的地址。

函数每次执行时，都创建一个不一样的执行环境，每个执行环境都有自己的作用域链

作用域链，初始化为[[scope]]属性中的值。初始化结束后，创建活动对象——也就是动态作用域，压入到作用域链中，处在最顶的位置。

活动对象——函数运行时的变量对象（词法环境），包含所有局部变量，命名参数，参数集合，this，声明函数等。执行函数销毁，活动对象也跟着销毁，除非，依然有变量在引用它。



## 闭包

函数中定义了函数，那么这个外层函数就是闭包，chrome devTools里边也能看到
- Local
- Closure
- Global

因为作用域链，所以，内层函数保存有闭包作用域的引用。如果内层函数并没有被销毁，就导致，闭包作用域因为依然存在引用，而不会被销毁。

因为我们内层函数保存的是闭包作用域的引用，所以，其为闭包作用域的最终状态，而不是内层函数创建时的状态。

## this

函数的内部属性，

在函数调用（执行）时，先初始化活动对象，活动对象的初始化，就包含this。

this指向调用对象。

然而，this会意外改变。

一个问题：

```
  function Thing() {
  };
  Thing.prototype.foo = "bar";
  Thing.prototype.logFoo = function () {
       var self = this;
       function doIt() {
           console.log(self.foo);
       }
       doIt();
   }

   function doItIndirectly(method) {
       method();
   }
   var thing = new Thing();
   thing.logFoo(); //logs "bar"
   doItIndirectly(thing.logFoo);
```

显然，this在函数作为参数传递的时候，调用者发生了变化。

这是因为，变量保存函数体入口地址，而变量，属于不同的变量对象，全局对象下，this自然指向window。
（其实很牵强。this在js引擎中究竟是怎么个运作方式，还是不清楚。）

## 一个问题——"."操作符，在内部实现，究竟做了那些操作？

在语法分析碰到"."的时候，该怎么办？

这个问题很有必要，它牵扯到两个问题：

第一——上文的this

第二——参数究竟是按值，还是按引用传递。

```
    var obj = {
      a: 1
    };
    function some ( o ) {
      o.a = 2;
      o = {};
      o.a = 3;
    }
    some(obj);
    console.log(obj.a);//2
```
网上很多解释，但是我觉得，最关键的，还是"."操作符，究竟是怎么个东西。


以上。
